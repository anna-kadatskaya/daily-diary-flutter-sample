workflows:
    ios-workflow-id:
        name: iOS Sample Workflow
        max_build_duration: 120
        instance_type: mac_mini_m2
        integrations:
            app_store_connect: Codemagic API Key
        environment:
            flutter: stable
            ios_signing:
              distribution_type: ad_hoc
              bundle_identifier: io.codemagic.daily-diary-flutter-sample
        scripts:
          - name: Set up code signing settings on Xcode project
            script: | 
              xcode-project use-profiles
          - name: Get Flutter packages
            script: | 
              flutter pub get
          - name: Install pods
            script: | 
              find . -name "Podfile" -execdir pod install \;
          - name: Flutter analyze
            script: | 
              flutter analyze
          - name: Flutter unit tests
            script: | 
              flutter test
            ignore_failure: true
          - name: Flutter build ipa
            script: | 
              flutter build ipa --release \
                --build-name=1.0.0 \
                --build-number=$(($(app-store-connect get-latest-app-store-build-number "$APP_STORE_APPLE_ID") + 1)) \
                --export-options-plist=/Users/builder/export_options.plist
          - name: Flutter build for simulator
            script: |
                flutter build ios --simulator
        artifacts:
          - build/ios/ipa/*.ipa
          - /tmp/xcodebuild_logs/*.log
          - flutter_drive.log
          - build/ios/iphonesimulator/Runner.app
        publishing:
          email:
            recipients:
              - anna.k@codemagic.io
            notify:
              success: true
              failure: true
        
    android-workflow-id:
        name: Android Sample Workflow
        max_build_duration: 120
        instance_type: linux_x2
        environment:
            flutter: 3.32.8
            android_signing:
                - codemagic
        scripts:
            - name: Set up local.properties
              script: | 
                echo "flutter.sdk=$HOME/programs/flutter" > "$CM_BUILD_DIR/android/local.properties"
            - name: Get Flutter packages
              script: | 
                flutter pub get
            - name: Build AAB with Flutter
              script: | 
                flutter build appbundle --release --android-skip-build-dependency-validation
        artifacts:
            - build/**/outputs/**/*.aab
            - build/**/outputs/**/mapping.txt
            - flutter_drive.log
        publishing:
            email:
                recipients:
                    - anna.k@codemagic.com
                notify:
                  success: true
                  failure: true
